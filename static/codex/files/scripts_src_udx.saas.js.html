<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>scripts/src/udx.saas.js - usabilitydynamics/lib-utility</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="usabilitydynamics/lib-utility"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/Utility.html">Utility</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/event.html">event</a></li>
            
                <li><a href="../modules/ud.html">ud</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: scripts/src/udx.saas.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/**
 * Global UD SaaS Interface
 *
 * @version 1.2
 * @description UD Loader. Initial global object extended by product-specific globals
 * @package UD
 * @author team@UD
 */
var ud = ( typeof ud === &#x27;object&#x27; ) ? ud : {};

ud.saas = ({

  &#x27;scope&#x27;: &#x27;ud.saas&#x27;,

  // ID of current connection
  &#x27;id&#x27;: null,

  // Status of a connection. False for no connection, null when pending, true when connected and instance sent
  &#x27;connected&#x27;: false,

  // URL of current socket connection
  &#x27;current&#x27;: null,

  &#x27;socket&#x27;: false,

  // Model of current instance (must be set by client)
  &#x27;instance&#x27;: null,

  // Log of received messages
  &#x27;messages&#x27;: [],

  &#x27;settings&#x27;: {
    &#x27;query_timeout&#x27;: 3000,
    &#x27;log&#x27;: {
      &#x27;errors&#x27;: true,
      &#x27;events&#x27;: false,
      &#x27;procedurals&#x27;: false,
      &#x27;all_data&#x27;: false
    }
  },


  /**
   * Establish connection with UD Driver.
   *
   * Triggered by client-side functions when SaaS support is requested.
   *
   * @since 1.0.0
   * @author potanin@UD
   */
  connect: function( model, args ) {
    &#x27;use strict&#x27;;
    var self = this;
    if( self.settings.log.procedurals ) { self.log( self.scope + &#x27;.connect()&#x27;, arguments ); }

    args = jQuery.extend( true, { &#x27;force new connection&#x27;: false, &#x27;secure&#x27;: true }, args ? args : {}, { &#x27;instance&#x27;: self.instance } );
    var url = ( args.secure ? &#x27;https://saas.usabilitydynamics.com:443/&#x27; : &#x27;http://saas.usabilitydynamics.com:80/&#x27; ) + ( typeof model === &#x27;string&#x27; ? model : &#x27;&#x27; );

    /* Initialize Connection */
    if( typeof io !== &#x27;object&#x27; ) {
      jQuery( document ).trigger( &#x27;ud::saas::update&#x27;,
        { message: &#x27;Socket.io Not Loaded, connection not established.&#x27;, args: arguments } );
      return false;
    }

    if( self.socket &amp;&amp; !args[ &#x27;force new connection&#x27; ] ) {
      self.emit( self.id + &#x27;::receive::instance&#x27;, { instance: self.instance } );
      return self.socket;
    }

    self.socket = io.connect( url, args );

    self.on( &#x27;connect&#x27;, function( data ) {

      self.id = self.socket.socket.sessionid;
      self.current = url;

      jQuery( document ).trigger( &#x27;ud::saas::connect&#x27;, self );

      jQuery( document ).trigger( &#x27;&#x27; + self.id + &#x27;::init&#x27;, self );

      /* Monitor all Updates */
      self.on( self.id + &#x27;::update&#x27;, function( data ) {
        if( data.message ) { self.messages.push( { &#x27;time&#x27;: new Date().getTime(), &#x27;message&#x27;: data.message, &#x27;screen&#x27;: self.instance.screen } ); }
        jQuery( document ).trigger( &#x27;&#x27; + self.id + &#x27;::update&#x27;, data );
      } );

      /* Send Instance / Authentication Data */
      self.on( self.id + &#x27;::request::instance&#x27;, function( data ) {
        self.emit( self.id + &#x27;::receive::instance&#x27;, { instance: self.instance } );

        self.connected = null;

        // Triggers to notify when an instance is authenticated and screen set
        self.on( self.id + &#x27;::update::screen_set&#x27;, function( data ) {
          jQuery( document ).trigger( &#x27;&#x27; + self.id + &#x27;::update::screen_set::&#x27; + data.screen,
            { &#x27;data&#x27;: data, &#x27;saas&#x27;: self } );
        } );

        self.on( self.id + &#x27;::update::authentication&#x27;, function( data ) {

          if( data.success ) {
            self.connected = true;
            jQuery( document ).trigger( &#x27;&#x27; + self.id + &#x27;::connected&#x27;, self );
          } else {
            self.connected = false;
            self.current = null;
            self.log( new Error( self.scope + &#x27;.connect() update::authentication - Failure.&#x27; ) );
          }

        } );

      } );

      self.on( &#x27;disconnect&#x27;, function() { // if( self.settings.log.events ) { self.log( self.scope + &#x27; -&gt; disconnect from &#x27; + self.id ); }

        jQuery( document ).trigger( &#x27;&#x27; + self.id + &#x27;::disconnected&#x27;, self );

        self.connected = false;
        self.current = null;
        self.id = null;

        if( self.settings.log.all_data &amp;&amp; typeof self.log_all === &#x27;function&#x27; ) {
          jQuery( document ).unbind( &#x27;io::data&#x27;, self.log_all );
        }

      } );

      if( self.settings.log.all_data &amp;&amp; typeof self.log_all === &#x27;function&#x27; ) {
        jQuery( document ).bind( &#x27;io::data&#x27;, self.log_all );
      }

    } );

    return self.socket;

  },


  /**
   * Disconnect from SaaS
   * 
   * @author peshkov@UD
   */
  disconnect: function() {
    &#x27;use strict&#x27;;
    var self = this;
    if( self.settings.log.procedurals ) { self.log( self.scope + &#x27;.disconnect()&#x27;, arguments ); }

    if( self.socket &amp;&amp; typeof self.socket.disconnect == &#x27;function&#x27; ) {
      self.socket.disconnect();
      self.socket.removeAllListeners();
      jQuery( document ).trigger( &#x27;ud::saas::disconnect&#x27;, self );
    }
  },


  /**
   * Programmatically Execute Emit
   *
   * Example: ud.saas.emit( &#x27;get_capabilities&#x27; );
   *
   * @since 1.1.0
   * @author potanin@UD
   */
  emit: function( action, data ) {
    &#x27;use strict&#x27;;
    var self = this;
    if( self.settings.log.events ) { self.log( self.scope + &#x27;.emit()&#x27;, arguments ); }

    if( self.id ) {
      data.session = data.session ? data.session : self.id;
    }

    self.socket.emit( action, data );
  },


  /**
   * Programmatically Execute Emit
   *
   * Example: ud.saas.emit( &#x27;get_capabilities&#x27; );
   *
   * @since 1.1.0
   * @author potanin@UD
   */
  on: function( action, callback ) {
    &#x27;use strict&#x27;;
    var self = this;
    if( self.settings.log.events ) { self.log( self.scope + &#x27;.on()&#x27;, arguments ); }

    if( self.socket ) {
      return self.socket.on( action, callback );
    }

    var interval = setInterval( function() {
      if( !self.socket ) { return ud.warning( &#x27;Socket not ready. &#x27; + action + &#x27; called too early. Retrying in several seconds...&#x27; ); }
      self.socket.on( action, callback );
      clearInterval( interval );
    }, 2500 );

    window.setTimeout( function() {
      ud.warning( &#x27;Socket attempts for &#x27; + action + &#x27; are up.&#x27; );
      clearInterval( interval );
    }, 10000 );

  },


  /**
   * Instance-specific emit/on handler
   *
   * A shorthand for a emit/on combination that tracks lookup instance.
   * The third argument can be a callback or a variable.
   *
   * @since 2.0
   * @author potanin@UD
   */
  query: function( action, request_data, callback ) {
    &#x27;use strict&#x27;;
    var self = this;
    if( self.settings.log.events ) { self.log( self.scope + &#x27;.get()&#x27;, arguments ); }

    if( !self.connected ) {
      ud.warning( self.scope + &#x27;.get() - Called too early. Scheduling re-try for &#x27; + self.id + &#x27;::connected event.&#x27;,
        arguments );
      jQuery( document ).one( &#x27;ud::saas::connected&#x27;, function() {
        ud.warning( self.scope + &#x27;.get() - Calling scheduled ud.saas.query() post &#x27; + self.id + &#x27;::connected event.&#x27;,
          arguments );
        self.query( action, request_data, callback );
      } );
    }

    // Create global variables for tracking instance listeners.
    window.ud.saas._instances = window.ud.saas._instances ? window.ud.saas._instances : {};

    // Create our custom hash for this request
    request_data._hash = parseInt( ( Math.random() ).toString().replace( &#x27;0.&#x27;, &#x27;&#x27; ) );

    // Create timeout event - no response in X many seconds, request is dropped.
    window.ud.saas._instances[ request_data._hash ] = setTimeout( function() {
      delete window.ud.saas._instances[ request_data._hash ];
      if( typeof callback === &#x27;function&#x27; ) {
        callback( new Error( &#x27;ud.saas.query() - No response received, dropping listener: &#x27; + &#x27;receive::&#x27; + action + &#x27;::&#x27; + request_data._hash ),
          request_data );
      } else {
        self.log( new Error( &#x27;ud.saas.query() - No response received, dropping listener: &#x27; + &#x27;receive::&#x27; + action + &#x27;::&#x27; + request_data._hash ),
          request_data );
      }
    }, self.settings.query_timeout );

    // Send request to SaaS
    self.socket.emit( &#x27;request::&#x27; + action, request_data );

    // Create listener for response with unique hash
    self.socket.on( &#x27;receive::&#x27; + action + &#x27;::&#x27; + request_data._hash, function( response_data ) {

      // Remove the timeout so it doesn&#x27;t trigger the callback
      clearTimeout( window.ud.saas._instances[ request_data._hash ] );

      switch( typeof callback ) {

        case &#x27;function&#x27;:
          callback( null, response_data );
          break;

        default:
          callback = response_data;
          break;

      }

    } );

    return null;

  },


  /**
   * Internal logging function.
   *
   * @version 1.0.0
   * @author potanin@UD
   */
  log: function( data ) {
    var self = this;

    if( typeof window.console !== &#x27;object&#x27; || /MSIE (\d+\.\d+);/.test( navigator.userAgent ) ) {
      return false;
    }

    if( typeof data === &#x27;object&#x27; &amp;&amp; data instanceof Error &amp;&amp; !self.settings.log.errors ) {
      return;
    }

    console.log.apply( console, arguments );

    return typeof arguments[0] === &#x27;boolean&#x27; ? arguments[0] : true;

  },


  /**
   * Enable Global IO Data Logger
   *
   * @since 2.0
   * @author potanin@UD
   */
  log_all: function( e, data ) {
    &#x27;use strict&#x27;;
    var self = this;

    if( typeof window.console === &#x27;object&#x27; || /MSIE (\d+\.\d+);/.test( navigator.userAgent ) ) {

      if( data.type === &#x27;event&#x27; ) {
        return console.log( &#x27;ud.saas.log_all()&#x27;, data );
      }

      if( data.type === &#x27;heartbeat&#x27; ) {
        // return console.log( &#x27;ud.saas.log_all()&#x27;, data );
      }

    }

    return false;

  }


});


    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
